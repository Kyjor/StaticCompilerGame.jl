<!doctype html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>SDL2 + Julia Physics Integration</title>
    <style>body {
  font-family: arial;
  margin: 0;
  padding: none;
}

.emscripten { padding-right: 0; margin-left: auto; margin-right: auto; display: block; }
div.emscripten { text-align: center; }
div.emscripten_border { border: 1px solid black; }
/* the canvas *must not* have any border or padding, or mouse coords will be wrong */
canvas.emscripten { border: 0px none; background-color: black; }

#emscripten_logo {
  display: inline-block;
  margin: 0;
  padding: 6px;
  width: 265px;
}

.spinner {
  height: 30px;
  width: 30px;
  margin: 0;
  margin-top: 20px;
  margin-left: 20px;
  display: inline-block;
  vertical-align: top;

  -webkit-animation: rotation .8s linear infinite;
  -moz-animation: rotation .8s linear infinite;
  -o-animation: rotation .8s linear infinite;
  animation: rotation 0.8s linear infinite;

  border-left: 5px solid rgb(235, 235, 235);
  border-right: 5px solid rgb(235, 235, 235);
  border-bottom: 5px solid rgb(235, 235, 235);
  border-top: 5px solid rgb(120, 120, 120);

  border-radius: 100%;
  background-color: rgb(189, 215, 46);
}

@-webkit-keyframes rotation {
  from {-webkit-transform: rotate(0deg);}
  to {-webkit-transform: rotate(360deg);}
}
@-moz-keyframes rotation {
  from {-moz-transform: rotate(0deg);}
  to {-moz-transform: rotate(360deg);}
}
@-o-keyframes rotation {
  from {-o-transform: rotate(0deg);}
  to {-o-transform: rotate(360deg);}
}
@keyframes rotation {
  from {transform: rotate(0deg);}
  to {transform: rotate(360deg);}
}

#status {
  display: inline-block;
  vertical-align: top;
  margin-top: 30px;
  margin-left: 20px;
  font-weight: bold;
  color: rgb(120, 120, 120);
}

#progress {
  height: 20px;
  width: 300px;
}

#controls {
  display: inline-block;
  float: right;
  vertical-align: top;
  margin-top: 30px;
  margin-right: 20px;
}

#output {
  width: 100%;
  height: 200px;
  margin: 0 auto;
  margin-top: 10px;
  border-left: 0px;
  border-right: 0px;
  padding-left: 0px;
  padding-right: 0px;
  display: block;
  background-color: black;
  color: white;
  font-family: 'Lucida Console', Monaco, monospace;
  outline: none;
}

/* Julia Physics Debug Panel */
#julia-debug {
  position: fixed;
  top: 10px;
  left: 10px;
  background: rgba(0, 0, 0, 0.8);
  color: white;
  padding: 10px;
  border-radius: 5px;
  font-family: monospace;
  font-size: 12px;
  z-index: 1000;
  max-width: 300px;
}

#julia-debug h4 {
  margin: 0 0 10px 0;
  color: #4CAF50;
}

.julia-status {
  margin: 5px 0;
}

.julia-value {
  color: #FFD700;
}
</style>
  </head>
  <body>
    <div class="spinner" id='spinner'></div>
    <div class="emscripten" id="status">Downloading...</div>

    <span id='controls'>
      <span><input type="checkbox" id="resize">Resize canvas</span>
      <span><input type="checkbox" id="pointerLock" checked>Lock/hide mouse pointer &nbsp;&nbsp;&nbsp;</span>
      <span><input type="button" value="Fullscreen" onclick="Module.requestFullscreen(document.getElementById('pointerLock').checked, 
                                                                                document.getElementById('resize').checked)">
      </span>
    </span>

    <div class="emscripten">
      <progress value="0" max="100" id="progress" hidden=1></progress>
    </div>

    <div class="emscripten_border">
      <canvas class="emscripten" id="canvas" oncontextmenu="event.preventDefault()" tabindex=-1></canvas>
    </div>
    <textarea id="output" rows="8"></textarea>

    <!-- Julia Physics Debug Panel -->
    <div id="julia-debug" style="display: none;">
      <h4>🎮 Julia Physics Debug</h4>
      <div class="julia-status">Status: <span class="julia-value" id="julia-status">Loading...</span></div>
      <div class="julia-status">Position: <span class="julia-value" id="julia-position">0, 0</span></div>
      <div class="julia-status">Velocity: <span class="julia-value" id="julia-velocity">0, 0</span></div>
      <div class="julia-status">On Ground: <span class="julia-value" id="julia-ground">false</span></div>
      <div class="julia-status">Input: <span class="julia-value" id="julia-input">None</span></div>
      <div class="julia-status">Color: <span class="julia-value" id="julia-color">0</span></div>
      <button onclick="toggleJuliaDebug()" style="margin-top: 10px;">Hide Debug</button>
    </div>

    <script type='text/javascript'>
      var statusElement = document.getElementById('status');
      var progressElement = document.getElementById('progress');
      var spinnerElement = document.getElementById('spinner');
      var canvasElement = document.getElementById('canvas');
      console.log(canvasElement)
      var outputElement = document.getElementById('output');
      if (outputElement) outputElement.value = ''; // clear browser cache

      // As a default initial behavior, pop up an alert when webgl context is lost. To make your
      // application robust, you may want to override this behavior before shipping!
      // See http://www.khronos.org/registry/webgl/specs/latest/1.0/#5.15.2
      canvasElement.addEventListener('webglcontextlost', (e) => {
        alert('WebGL context lost. You will need to reload the page.');
        e.preventDefault();
      }, false);

      // Julia Physics Integration
      let juliaModule = null;
      let juliaLoaded = false;
      
      // Game state for Julia physics
      let gameState = {
        square: {
          x: 100,
          y: 300,
          velX: 0,
          velY: 0,
          onGround: true,
          colorState: 1
        },
        input: {
          A: false,
          D: false,
          Space: false
        }
      };

      var Module = {
        print(...args) {
          console.log(...args);
          // These replacements are necessary if you render to raw HTML
          //text = text.replace(/&/g, "&amp;");
          //text = text.replace(/</g, "&lt;");
          //text = text.replace(/>/g, "&gt;");
          //text = text.replace('\n', '<br>', 'g');
          if (outputElement) {
            var text = args.join(' ');
            outputElement.value += text + "\n";
            outputElement.scrollTop = outputElement.scrollHeight; // focus on bottom
          }
        },
        canvas: canvasElement,
        setStatus(text) {
          Module.setStatus.last ??= { time: Date.now(), text: '' };
          if (text === Module.setStatus.last.text) return;
          var m = text.match(/([^(]+)\((\d+(\.\d+)?)\/(\d+)\)/);
          var now = Date.now();
          // if this is a progress update, skip it if too soon
          if (m && now - Module.setStatus.last.time < 30) return;
          Module.setStatus.last.time = now;
          Module.setStatus.last.text = text;
          if (m) {
            text = m[1];
            progressElement.value = parseInt(m[2])*100;
            progressElement.max = parseInt(m[4])*100;
            progressElement.hidden = false;
            spinnerElement.hidden = false;
          } else {
            progressElement.value = null;
            progressElement.max = null;
            progressElement.hidden = true;
            if (!text) spinnerElement.style.display = 'none';
          }
          statusElement.innerHTML = text;
        },
        totalDependencies: 0,
        monitorRunDependencies(left) {
          this.totalDependencies = Math.max(this.totalDependencies, left);
          Module.setStatus(left ? 'Preparing... (' + (this.totalDependencies-left) + '/' + this.totalDependencies + ')' : 'All downloads complete.');
        },
        
        // Enhanced onRuntimeInitialized for Julia integration
        onRuntimeInitialized() {
          console.log("🎮 SDL2 WASM Loaded!");
          
          // Initialize SDL (your existing code)
          try {
            Module._main(); // This calls the C main() function which sets up SDL
            console.log("✅ SDL initialized successfully");
          } catch (e) {
            console.error("❌ Failed to initialize SDL:", e);
            return;
          }
          
          // Load Julia physics module
          loadJuliaPhysics();
          
          // Add keyboard controls for debug
          document.addEventListener('keydown', (e) => {
            if (e.key === 'F1') {
              toggleJuliaDebug();
            }
          });
          
          // Start the enhanced game loop
          startEnhancedGameLoop();
        }
      };
      
      Module.setStatus('Downloading...');
      window.onerror = (event) => {
        // TODO: do not warn on ok events like simulating an infinite loop or exitStatus
        Module.setStatus('Exception thrown, see JavaScript console');
        spinnerElement.style.display = 'none';
        Module.setStatus = (text) => {
          if (text) console.error('[post-exception status] ' + text);
        };
      };

      // Load Julia WebAssembly module for physics
      async function loadJuliaPhysics() {
        try {
          console.log("🔧 Loading Julia physics module...");
          updateJuliaDebugStatus("Loading Julia...");
          
          // Load Julia module (adjust path as needed)
          const script = document.createElement('script');
          script.src = 'julia_sdl_wasm/julia_sdl.js';
          script.onload = () => {
            console.log("📦 Julia script loaded, initializing module...");
            
            // Initialize Julia module
            window.JuliaModule = window.Module;
            window.Module = Module; // Restore SDL2 module
            
            window.JuliaModule({}).then(mod => {
              juliaModule = mod;
              juliaLoaded = true;
              console.log("✅ Julia physics module loaded!");
              updateJuliaDebugStatus("Julia Ready");
              
              // Test Julia functions
              testJuliaFunctions();
            }).catch(err => {
              console.error("❌ Failed to initialize Julia module:", err);
              updateJuliaDebugStatus("Julia Failed");
            });
          };
          script.onerror = (err) => {
            console.error("❌ Failed to load Julia script:", err);
            updateJuliaDebugStatus("Julia Load Failed");
          };
          document.head.appendChild(script);
          
        } catch (error) {
          console.error("❌ Failed to load Julia physics:", error);
          updateJuliaDebugStatus("Julia Error");
        }
      }

      // Test Julia functions
      function testJuliaFunctions() {
        if (!juliaModule) return;
        
        try {
          // Test basic function calls
          const testX = juliaModule._get_new_x(100, 0, 1, 0); // Move left
          const testY = juliaModule._get_new_y(300, 0, 1, 1); // Jump
          const testColor = juliaModule._get_square_color(1, 0); // Ground color
          
          console.log("🧪 Julia function tests:");
          console.log("  Move left: 100 → " + testX);
          console.log("  Jump: 300 → " + testY);
          console.log("  Ground color: " + testColor);
          
          updateJuliaDebugStatus("Julia Working ✅");
          
        } catch (error) {
          console.error("❌ Julia function test failed:", error);
          updateJuliaDebugStatus("Julia Test Failed");
        }
      }

      // Enhanced game loop with Julia physics
      function startEnhancedGameLoop() {
        function runMainLoop() {
          // Get input state from SDL (your existing code)
          let inputPtr = Module._get_input_state();
          
          // Read key states from WASM memory (your existing code)
          let key_A = Module.HEAPU8[inputPtr];      // Left
          let key_D = Module.HEAPU8[inputPtr + 1];  // Right  
          let key_Space = Module.HEAPU8[inputPtr + 2]; // Jump
          
          // Update input state
          gameState.input.A = !!key_A;
          gameState.input.D = !!key_D;
          gameState.input.Space = !!key_Space;
          
          // Update physics using Julia (if loaded) or fallback
          if (juliaLoaded && juliaModule) {
            updatePhysicsWithJulia();
          } else {
            updatePhysicsJavaScript();
          }
          
          // Send updated entities to SDL2 (your existing system)
          updateSDL2Entities();
          
          // Update debug display
          updateJuliaDebugDisplay();
          
          // Call the SDL2 main loop
          try {
            Module._main_loop(); // Your existing main loop function
          } catch (e) {
            // Handle if main_loop doesn't exist
          }
          
          // Continue game loop
          requestAnimationFrame(runMainLoop);
        }
        
        runMainLoop();
      }

      // Update physics using Julia WebAssembly functions
      function updatePhysicsWithJulia() {
        const { square, input } = gameState;
        
        try {
          // Call Julia functions for physics calculations
          const newX = juliaModule._get_new_x(
            square.x, 
            square.velX, 
            input.A ? 1 : 0,     // key_A (left)
            input.D ? 1 : 0      // key_D (right)
          );
          
          const newY = juliaModule._get_new_y(
            square.y,
            square.velY,
            square.onGround ? 1 : 0,  // on_ground
            input.Space ? 1 : 0       // key_space (jump)
          );
          
          const newVelY = juliaModule._get_new_vel_y(
            square.y,
            square.velY,
            square.onGround ? 1 : 0,  // on_ground
            input.Space ? 1 : 0       // key_space (jump)
          );
          
          const newOnGround = juliaModule._check_on_ground(
            newY,
            newVelY
          );
          
          const colorState = juliaModule._get_square_color(
            square.onGround ? 1 : 0,  // on_ground
            input.Space ? 1 : 0       // key_space
          );
          
          // Update game state with Julia results
          square.x = newX;
          square.y = newY;
          square.velY = newVelY;
          square.onGround = !!newOnGround;
          square.colorState = colorState;
          
          // Update velocity X based on input
          if (input.A) {
            square.velX = -5;
          } else if (input.D) {
            square.velX = 5;
          } else {
            square.velX = 0;
          }
          
        } catch (error) {
          console.error("❌ Julia physics error:", error);
          // Fallback to JavaScript physics
          updatePhysicsJavaScript();
        }
      }

      // Fallback JavaScript physics
      function updatePhysicsJavaScript() {
        const { square, input } = gameState;
        
        // Simple physics simulation
        square.velY += 1; // Gravity
        
        // Horizontal movement
        if (input.A) {
          square.velX = -5;
        } else if (input.D) {
          square.velX = 5;
        } else {
          square.velX = 0;
        }
        
        // Jumping
        if (input.Space && square.onGround) {
          square.velY = -12;
          square.onGround = false;
        }
        
        // Update position
        square.x += square.velX;
        square.y += square.velY;
        
        // Boundary checking
        if (square.x < 0) square.x = 0;
        if (square.x > 768) square.x = 768; // 800 - 32
        
        // Ground collision
        const groundY = 548; // 600 - 32 - 20
        if (square.y >= groundY) {
          square.y = groundY;
          square.velY = 0;
          square.onGround = true;
        }
        
        // Color state for rendering
        if (input.Space) {
          square.colorState = 2; // Yellow - jumping
        } else if (square.onGround) {
          square.colorState = 1; // Green - on ground
        } else {
          square.colorState = 0; // Red - in air
        }
      }

      // Update SDL2 entities with Julia physics results
      function updateSDL2Entities() {
        const { square } = gameState;
        
        // Create entity data in the format your SDL2 system expects
        const entityData = [{
          x: square.x / 32.0,  // Convert to your coordinate system
          y: square.y / 32.0,
          colorState: square.colorState
        }];
        
        // Use your existing entity update function
        if (typeof updateGameData === 'function') {
          updateGameData(JSON.stringify(entityData));
        }
        
        // Or trigger the custom event you're listening for
        const event = new CustomEvent('send-to-c', { 
          detail: JSON.stringify(entityData) 
        });
        document.dispatchEvent(event);
      }

      // Debug panel functions
      function toggleJuliaDebug() {
        const debugPanel = document.getElementById('julia-debug');
        if (debugPanel.style.display === 'none') {
          debugPanel.style.display = 'block';
        } else {
          debugPanel.style.display = 'none';
        }
      }

      function updateJuliaDebugStatus(status) {
        const statusElement = document.getElementById('julia-status');
        if (statusElement) {
          statusElement.textContent = status;
        }
      }

      function updateJuliaDebugDisplay() {
        const { square, input } = gameState;
        
        document.getElementById('julia-position').textContent = `${Math.round(square.x)}, ${Math.round(square.y)}`;
        document.getElementById('julia-velocity').textContent = `${square.velX}, ${Math.round(square.velY)}`;
        document.getElementById('julia-ground').textContent = square.onGround ? 'Yes' : 'No';
        document.getElementById('julia-input').textContent = [
          input.A ? 'A' : '',
          input.D ? 'D' : '',
          input.Space ? 'Space' : ''
        ].filter(Boolean).join(', ') || 'None';
        document.getElementById('julia-color').textContent = square.colorState;
      }

      // Show debug panel initially
      setTimeout(() => {
        document.getElementById('julia-debug').style.display = 'block';
      }, 2000);

      // Export for debugging
      window.gameState = gameState;
      window.juliaModule = () => juliaModule;
      window.toggleJuliaDebug = toggleJuliaDebug;
      </script>
    <script src="index.js"></script>
    <script type="text/javascript" src="sdl2.js"></script>
  </body>
</html> 